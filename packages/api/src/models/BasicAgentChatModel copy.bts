import { logger } from '@/utils/logger';
import { IChatModel } from '@sharedtypes';
import { ReadFileTool, WriteFileTool, BingSerpAPI } from 'langchain/tools';
import { InMemoryFileStore } from 'langchain/stores/file/in_memory';
import { MemoryVectorStore } from 'langchain/vectorstores/memory';
import { OpenAIEmbeddings } from 'langchain/embeddings/openai';
import { ChatOpenAI } from 'langchain/chat_models/openai';
import { Calculator } from 'langchain/tools/calculator';
import { initializeAgentExecutorWithOptions } from 'langchain/agents';

export class TBasicAgentChatModel implements IChatModel {
  readonly id = 'basicagent1';
  readonly name = 'Basic Agent';
  readonly group = 'Experimental';
  readonly enabled = true;
  readonly contexts = [];
  readonly tools = [];

  async call(input: { role?: string; content: string }[], options?: Record<string, unknown>): Promise<{ content: string } & Record<string, any>> {
    const model = new ChatOpenAI({ temperature: 0 });

    const tools = [
      new BingSerpAPI(process.env.BINGSERPAPI_API_KEY, {
        location: 'Bangalore, India',
        hl: 'en',
        gl: 'us',
      }),
      new Calculator(),
    ];
    const executor = await initializeAgentExecutorWithOptions(tools, model, {
      agentType: 'chat-zero-shot-react-description',
    });
    logger.debug('Loaded Basic Agent.');

    const inputMsg = input[input.length - 1].content;
    console.log(`Executing with input "${inputMsg}"...`);

    const response = await executor.call({ input });

    logger.debug(JSON.stringify(response.intermediateSteps, null, 2));
    const result = {
      content: response.output,
    };

    return result;
  }

  toJSON(): IChatModel {
    return {
      id: this.id,
      name: this.name,
      group: this.group,
      enabled: this.enabled,
      contexts: this.contexts,
      tools: this.tools,
    };
  }
}
